<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>USD/TWD 歷史匯率與排序分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #2980b9;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --up-color: #ef4444; /* 紅色 */
            --down-color: #10b981; /* 綠色 */
            --highlight: #eab308; /* 黃色高亮 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        /* 標題區塊 */
        header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 16px;
            text-align: center;
        }

        h1 {
            font-size: 20px;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .subtitle {
            font-size: 13px;
            color: var(--text-sub);
        }

        /* 儀表板卡片 (2x2) */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 110px;
        }

        /* 即時匯率特別樣式 */
        .live-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            position: relative;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-color);
        }
        
        .stat-sub {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
        }

        .source-tag {
            font-size: 10px;
            background-color: #0284c7;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .diff-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .diff-positive { background-color: rgba(239, 68, 68, 0.1); color: var(--up-color); }
        .diff-negative { background-color: rgba(16, 185, 129, 0.1); color: var(--down-color); }

        /* 更新動畫 */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .loading-text {
            animation: pulse 1.5s infinite;
        }

        /* 按鈕 */
        .btn-link {
            display: block;
            width: 100%;
            text-align: center;
            background-color: var(--accent-color);
            color: white;
            padding: 12px 0;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .btn-link:hover {
            background-color: #1e6091;
        }

        /* 圖表區 */
        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin: 24px 0 12px 0;
            display: flex;
            align-items: center;
        }
        .section-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 16px;
            background: var(--accent-color);
            margin-right: 8px;
            border-radius: 2px;
        }

        .chart-box {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 12px;
            height: 300px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        /* 排序控制區 */
        .sort-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .sort-btn {
            background: white;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-main);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sort-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            box-shadow: 0 2px 5px rgba(41, 128, 185, 0.3);
        }

        /* 表格區 */
        .table-wrapper {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            white-space: nowrap;
        }

        th {
            background-color: #f8f9fa;
            color: var(--text-sub);
            font-weight: 600;
            text-align: left;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:nth-child(even) { background-color: #fafafa; }
        
        .rate-up { color: var(--up-color); font-weight: bold; }
        .rate-down { color: var(--down-color); font-weight: bold; }
        
        .event-text {
            font-size: 12px;
            color: #555;
            white-space: normal;
            min-width: 180px;
        }

        footer {
            text-align: center;
            font-size: 11px;
            color: #9ca3af;
            margin-top: 30px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>USD/TWD 歷史匯率與排序分析</h1>
        <div class="subtitle">1975 - 2025 | 中央銀行歷史數據基準</div>
        <a href="https://www.moneydj.com/iquote/iQuoteExchange.djhtm" target="_blank" class="btn-link">
            <i class="fa-solid fa-chart-line"></i> 前往 MoneyDJ 查詢即時匯率
        </a>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">50年平均值</div>
            <div class="stat-value" id="avgRate">--</div>
            <div class="stat-sub">長期基準線</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">歷史最低 (台幣強)</div>
            <div class="stat-value" style="color:var(--down-color);" id="minRate">--</div>
            <div class="stat-sub" id="minYear">--</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">2025 目前參考</div>
            <div class="stat-value" id="currentRateDisplay">--</div>
            <div style="display:flex; align-items: center; justify-content: center; margin-top: 4px;">
                <span class="stat-sub">乖離率 </span>
                <span id="diffBadge" class="diff-tag">--%</span>
            </div>
        </div>

        <div class="stat-card live-card">
            <div class="source-tag">資料源: 台灣銀行</div>
            <div class="stat-label">現金賣出 (Cash Sell)</div>
            <div class="stat-value loading-text" id="liveBotRate" style="color:#0284c7;">--.--</div>
            <div class="stat-sub" id="liveUpdateTime">連線更新中...</div>
        </div>
    </div>

    <div class="section-title">趨勢走勢圖</div>
    <div class="chart-box">
        <canvas id="rateChart"></canvas>
    </div>

    <div class="section-title">年度詳細數據</div>
    
    <div class="sort-controls">
        <button class="sort-btn active" onclick="sortData('year')">
            <i class="fa-regular fa-calendar"></i> 依年份
        </button>
        <button class="sort-btn" onclick="sortData('high')">
            <i class="fa-solid fa-arrow-down-wide-short"></i> 匯率由高到低
        </button>
        <button class="sort-btn" onclick="sortData('low')">
            <i class="fa-solid fa-arrow-up-wide-short"></i> 匯率由低到高
        </button>
    </div>

    <div class="table-wrapper">
        <table id="dataTable">
            <thead>
                <tr>
                    <th width="15%">年度</th>
                    <th width="25%">匯率</th>
                    <th>重大財經事件</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
    </div>

    <footer>
        <p>Generated by Gemini AI Assistant</p>
        <p>註：因 MoneyDJ 防爬蟲限制，卡片數值來源為台灣銀行 CSV 以確保穩定顯示，按鈕則連結至 MoneyDJ。</p>
    </footer>
</div>

<script>
    // 1. 定義數據 (50年完整數據)
    const historicalData = [
        { year: 1975, rate: 38.00, event: "固定匯率時期 (1 USD = 38 TWD)" },
        { year: 1978, rate: 36.00, event: "改為機動匯率 / 中美斷交" },
        { year: 1980, rate: 36.01, event: "第二次石油危機" },
        { year: 1983, rate: 40.27, event: "美元利率歷史高點" },
        { year: 1985, rate: 39.85, event: "廣場協議 (美元開始走貶)" },
        { year: 1987, rate: 28.55, event: "台幣大幅升值 / 解除外匯管制" },
        { year: 1990, rate: 26.89, event: "台股崩盤 / 資金外流" },
        { year: 1992, rate: 24.52, event: "★ 歷史最低點 (台幣最強)" },
        { year: 1995, rate: 27.27, event: "台海飛彈危機" },
        { year: 1997, rate: 32.64, event: "★ 亞洲金融風暴" },
        { year: 2000, rate: 31.23, event: "網路泡沫破裂" },
        { year: 2001, rate: 35.00, event: "911 恐怖攻擊" },
        { year: 2003, rate: 34.42, event: "SARS 疫情" },
        { year: 2005, rate: 32.17, event: "" },
        { year: 2008, rate: 31.52, event: "★ 全球金融海嘯 (Lehman Brothers)" },
        { year: 2009, rate: 33.06, event: "量化寬鬆 (QE) 開始" },
        { year: 2010, rate: 31.64, event: "後金融海嘯復甦" },
        { year: 2012, rate: 29.62, event: "歐債危機" },
        { year: 2015, rate: 31.74, event: "中國股災 / 匯改" },
        { year: 2016, rate: 32.26, event: "英國脫歐 / 川普當選" },
        { year: 2017, rate: 30.43, event: "台幣強勁升值" },
        { year: 2018, rate: 30.15, event: "中美貿易戰開打" },
        { year: 2019, rate: 30.91, event: "台商回流投資" },
        { year: 2020, rate: 29.54, event: "COVID-19 疫情 / 無限QE" },
        { year: 2021, rate: 28.02, event: "台灣出口最強年 (25年新低)" },
        { year: 2022, rate: 29.76, event: "美國聯準會暴力升息" },
        { year: 2023, rate: 31.16, event: "美元高利環境持續" },
        { year: 2024, rate: 32.10, event: "AI 產業熱潮 / 強勢美元" },
        { year: 2025, rate: 32.65, event: "目前匯率區間 (2025 Est.)" }
    ];

    let globalAvg = 0; // 全域變數儲存平均值

    // 2. 初始化
    function initDashboard() {
        console.log("初始化...");
        
        // 統計計算
        const rates = historicalData.map(d => d.rate);
        const sum = rates.reduce((a, b) => a + b, 0);
        globalAvg = sum / rates.length;
        
        const min = Math.min(...rates);
        const minYear = historicalData.find(d => d.rate === min).year;
        const currentData = historicalData[historicalData.length - 1];
        
        // 更新卡片
        document.getElementById('avgRate').innerText = globalAvg.toFixed(2);
        document.getElementById('minRate').innerText = min.toFixed(2);
        document.getElementById('minYear').innerText = `(${minYear})`;
        document.getElementById('currentRateDisplay').innerText = currentData.rate.toFixed(2);

        // 乖離率
        const diffPercent = ((currentData.rate - globalAvg) / globalAvg) * 100;
        const diffBadge = document.getElementById('diffBadge');
        diffBadge.innerText = (diffPercent > 0 ? "+" : "") + diffPercent.toFixed(2) + "%";
        diffBadge.className = diffPercent > 0 ? "diff-tag diff-positive" : "diff-tag diff-negative";

        // 繪圖與製表
        renderChart(globalAvg);
        sortData('year'); // 預設依年份排序
        
        // 抓取匯率
        fetchLiveRate();
    }

    // 3. 排序邏輯
    function sortData(mode) {
        // 更新按鈕樣式
        const btns = document.querySelectorAll('.sort-btn');
        btns.forEach(btn => btn.classList.remove('active'));
        
        // 找出被點擊的按鈕並加亮
        // 這裡簡單處理：依序對應 year, high, low
        if(mode === 'year') btns[0].classList.add('active');
        if(mode === 'high') btns[1].classList.add('active');
        if(mode === 'low') btns[2].classList.add('active');

        // 複製陣列避免動到原資料
        let sortedData = [...historicalData];

        if (mode === 'year') {
            // 年份倒序 (新的在上面)
            sortedData.sort((a, b) => b.year - a.year);
        } else if (mode === 'high') {
            // 匯率高到低
            sortedData.sort((a, b) => b.rate - a.rate);
        } else if (mode === 'low') {
            // 匯率低到高
            sortedData.sort((a, b) => a.rate - b.rate);
        }

        renderTable(sortedData);
    }

    // 4. 渲染表格
    function renderTable(dataToRender) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        dataToRender.forEach(item => {
            const tr = document.createElement('tr');
            // 簡單的紅綠判斷
            const colorClass = item.rate >= globalAvg ? 'rate-up' : 'rate-down';
            
            tr.innerHTML = `
                <td><strong>${item.year}</strong></td>
                <td class="${colorClass}">${item.rate.toFixed(2)}</td>
                <td class="event-text">${item.event}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 5. 繪製圖表 (維持依年份排序的折線圖)
    function renderChart(avgLine) {
        const ctx = document.getElementById('rateChart').getContext('2d');
        // 圖表資料必須按年份正序，否則線會亂跑
        const chartData = [...historicalData].sort((a, b) => a.year - b.year);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => d.year),
                datasets: [{
                    label: '匯率走勢',
                    data: chartData.map(d => d.rate),
                    borderColor: '#2980b9',
                    backgroundColor: 'rgba(41, 128, 185, 0.1)',
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: true,
                    tension: 0.3
                }, {
                    label: '50年平均線',
                    data: Array(chartData.length).fill(avgLine),
                    borderColor: '#e74c3c',
                    borderWidth: 1.5,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { boxWidth: 10, font: { size: 11 } } },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return chartData[context.dataIndex].event 
                                    ? ` ${chartData[context.dataIndex].event}` : '';
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 6 } },
                    y: { min: 20 }
                }
            }
        });
    }

    // 6. 抓取匯率 (使用 corsproxy.io + 台銀 CSV 以確保穩定)
    async function fetchLiveRate() {
        const rateEl = document.getElementById('liveBotRate');
        const timeEl = document.getElementById('liveUpdateTime');
        
        // 穩定的代理 + 台銀數據源
        const targetUrl = 'https://rate.bot.com.tw/xrt/flcsv/0/day';
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

        try {
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("Network response was not ok");
            const csvText = await response.text();
            
            const lines = csvText.split(/\r?\n/);
            let usdRate = null;

            for (let line of lines) {
                if (line.includes('USD') && line.includes('美金')) {
                    const columns = line.split(',');
                    if (columns[2]) usdRate = parseFloat(columns[2].trim());
                    break;
                }
            }

            if (usdRate && !isNaN(usdRate)) {
                rateEl.innerText = usdRate.toFixed(2);
                rateEl.classList.remove('loading-text');
                
                const now = new Date();
                const timeString = now.getHours().toString().padStart(2, '0') + ':' + 
                                 now.getMinutes().toString().padStart(2, '0');
                timeEl.innerText = `更新於: ${timeString}`;
                timeEl.style.color = "#0369a1";
            } else {
                throw new Error("Data format error");
            }
        } catch (error) {
            console.error("Fetch failed:", error);
            rateEl.innerHTML = `<span style="font-size:16px; color:#999;">--.--</span>`;
            timeEl.innerText = "無法自動更新";
        }
    }

    // 啟動
    window.onload = initDashboard;

</script>

</body>
</html>
